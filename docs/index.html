<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voidgun</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap');
        
        :root {
            --bg: #0a0a0c;
            --card-bg: #111114;
            --border: #1f1f24;
            --text: #e4e4e7;
            --text-dim: #71717a;
            --accent: #84cc16;
            --accent-dim: #65a30d;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            font-size: 16px;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            line-height: 1.7;
        }
        
        .ascii-logo {
            font-size: 0.55rem;
            color: var(--accent);
            white-space: pre;
            margin-bottom: 2rem;
            text-align: center;
            opacity: 0.9;
        }
        
        header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        
        .tagline {
            color: var(--text-dim);
            font-size: 1rem;
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            max-width: 520px;
            width: 100%;
            margin-bottom: 1.5rem;
        }
        
        .progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
            padding: 0 1rem;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            opacity: 0.4;
            transition: opacity 0.3s;
        }
        
        .step.active {
            opacity: 1;
        }
        
        .step.completed {
            opacity: 0.7;
        }
        
        .step-num {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .step.active .step-num {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        .step.completed .step-num {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg);
        }
        
        .step-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .step.active .step-label {
            color: var(--text);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .card-desc {
            color: var(--text-dim);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }
        
        .info-box {
            background: var(--bg);
            border-left: 3px solid var(--accent);
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-dim);
            line-height: 1.5;
        }
        
        .info-box strong {
            color: var(--text);
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }
        
        .btn-primary:hover {
            background: var(--accent-dim);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            margin-top: 0.75rem;
        }
        
        .btn-secondary:hover {
            border-color: var(--text-dim);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border);
            font-size: 0.95rem;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: var(--text-dim);
        }
        
        .info-value {
            color: var(--text);
            font-weight: 500;
        }
        
        .info-value.accent {
            color: var(--accent);
        }
        
        .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            word-break: break-all;
            line-height: 1;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }
        
        .status-dot.connected {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }
        
        .status-dot.pending {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .hidden {
            display: none !important;
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .input {
            width: 100%;
            padding: 0.875rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text);
        }
        
        .input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .balance-display {
            text-align: center;
            padding: 2rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
        
        .balance-label {
            font-size: 0.9rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        
        .balance-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .balance-token {
            font-size: 1rem;
            color: var(--text-dim);
            margin-left: 0.5rem;
        }
        
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .actions .btn {
            padding: 0.75rem;
        }
        
        footer {
            margin-top: auto;
            padding-top: 2rem;
            text-align: center;
        }
        
        footer a {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 0.9rem;
            margin: 0 0.75rem;
            transition: color 0.2s;
        }
        
        footer a:hover {
            color: var(--accent);
        }
        
        .note-list {
            margin-bottom: 1.5rem;
        }
        
        .note-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.875rem;
            background: var(--bg);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .note-token {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .note-icon {
            width: 28px;
            height: 28px;
            background: var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
        }
        
        .note-amount {
            color: var(--accent);
            font-weight: 600;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 100;
        }
        
        .modal {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .modal-actions .btn {
            flex: 1;
        }
        
        /* Focus styles for accessibility */
        button:focus,
        a:focus,
        input:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
        
        .input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(132, 204, 22, 0.2);
        }
        
        /* Demo mode banner */
        .demo-banner {
            background: var(--warning);
            color: var(--bg);
            text-align: center;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            border-radius: 4px;
        }
        
        /* Error message styles */
        .input-error {
            color: var(--error);
            font-size: 0.8rem;
            margin-top: 0.25rem;
            min-height: 1.2em;
        }
        
        .input.error {
            border-color: var(--error);
        }
    </style>
</head>
<body>
    <pre class="ascii-logo">
██╗   ██╗ ██████╗ ██╗██████╗  ██████╗ ██╗   ██╗███╗   ██╗
██║   ██║██╔═══██╗██║██╔══██╗██╔════╝ ██║   ██║████╗  ██║
██║   ██║██║   ██║██║██║  ██║██║  ███╗██║   ██║██╔██╗ ██║
╚██╗ ██╔╝██║   ██║██║██║  ██║██║   ██║██║   ██║██║╚██╗██║
 ╚████╔╝ ╚██████╔╝██║██████╔╝╚██████╔╝╚██████╔╝██║ ╚████║
  ╚═══╝   ╚═════╝ ╚═╝╚═════╝  ╚═════╝  ╚═════╝ ╚═╝  ╚═══╝
    </pre>
    
    <header>
        <p class="tagline">privacy via proxy // railgun integration</p>
    </header>
    
    <!-- Stage 0: Connect Wallet -->
    <div class="card" id="stage-connect">
        <div class="progress">
            <div class="step active" data-step="0">
                <div class="step-num">1</div>
                <div class="step-label">Wallet</div>
            </div>
            <div class="step" data-step="1">
                <div class="step-num">2</div>
                <div class="step-label">Network</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-num">3</div>
                <div class="step-label">Keys</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-num">4</div>
                <div class="step-label">Ready</div>
            </div>
        </div>
        
        <h2 class="card-title">Connect Wallet</h2>
        <p class="card-desc">Connect your Ethereum wallet to begin. Your keys will be derived from a signature.</p>
        
<div class="info-box">
            <strong>Your wallet retains full spending authority.</strong>
            The proxy cannot steal funds - only wallet-signed transactions authorize spends.
        </div>
        
        <button class="btn btn-primary" onclick="connectWallet()">
            Connect Wallet
        </button>
    </div>
    
    <!-- Stage 1: Add Network -->
    <div class="card hidden" id="stage-network">
        <div class="progress">
            <div class="step completed" data-step="0">
                <div class="step-num">+</div>
                <div class="step-label">Wallet</div>
            </div>
            <div class="step active" data-step="1">
                <div class="step-num">2</div>
                <div class="step-label">Network</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-num">3</div>
                <div class="step-label">Keys</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-num">4</div>
                <div class="step-label">Ready</div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-dot connected"></div>
            <span id="connected-address">0x0000...0000</span>
        </div>
        
        <h2 class="card-title">Add Voidgun Network</h2>
        <p class="card-desc">Add Voidgun as a custom RPC network in your wallet. Transactions route through the privacy proxy.</p>
        
        <div class="info-row">
            <span class="info-label">Network Name</span>
            <span class="info-value">Voidgun</span>
        </div>
        <div class="info-row">
            <span class="info-label">RPC URL</span>
            <span class="info-value">https://rpc.voidgun.io</span>
        </div>
        <div class="info-row">
            <span class="info-label">Chain ID</span>
            <span class="info-value">1</span>
        </div>
        <div class="info-row" style="margin-bottom: 1.5rem;">
            <span class="info-label">Currency</span>
            <span class="info-value">ETH</span>
        </div>
        
        <button class="btn btn-primary" onclick="addNetwork()">
            Add Network
        </button>
        <button class="btn btn-secondary" onclick="skipNetwork()">
            Skip (Manual Setup)
        </button>
    </div>
    
    <!-- Stage 2: Derive Keys -->
    <div class="card hidden" id="stage-keys">
        <div class="progress">
            <div class="step completed" data-step="0">
                <div class="step-num">+</div>
                <div class="step-label">Wallet</div>
            </div>
            <div class="step completed" data-step="1">
                <div class="step-num">+</div>
                <div class="step-label">Network</div>
            </div>
            <div class="step active" data-step="2">
                <div class="step-num">3</div>
                <div class="step-label">Keys</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-num">4</div>
                <div class="step-label">Ready</div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-dot connected"></div>
            <span id="connected-address-2">0x0000...0000</span>
        </div>
        
        <h2 class="card-title">Derive Privacy Keys</h2>
        <p class="card-desc">Sign a message to derive your Railgun keys. No new seed phrase needed.</p>
        
<div class="info-box">
            <strong>Key Derivation:</strong> Signature → Entropy → BIP39 Mnemonic → BIP32 Baby Jubjub Keys (Spending, Viewing, Nullifying)
        </div>
        
        <button class="btn btn-primary" id="btn-derive" onclick="deriveKeys(this)">
            Sign & Derive Keys
        </button>
    </div>
    
    <!-- Stage 3: Ready / Dashboard -->
    <div class="card hidden" id="stage-ready">
        <div class="progress">
            <div class="step completed" data-step="0">
                <div class="step-num">+</div>
                <div class="step-label">Wallet</div>
            </div>
            <div class="step completed" data-step="1">
                <div class="step-num">+</div>
                <div class="step-label">Network</div>
            </div>
            <div class="step completed" data-step="2">
                <div class="step-num">+</div>
                <div class="step-label">Keys</div>
            </div>
            <div class="step active" data-step="3">
                <div class="step-num">+</div>
                <div class="step-label">Ready</div>
            </div>
        </div>
        
        <div class="status">
            <div class="status-dot connected"></div>
            <span id="connected-address-3">0x0000...0000</span>
        </div>
        
        <div class="balance-display">
            <div class="balance-label">Shielded Balance</div>
            <div>
                <span class="balance-value" id="balance-value">0.00</span>
                <span class="balance-token">ETH</span>
            </div>
        </div>
        
        <div class="note-list" id="note-list">
            <!-- Notes will be populated here -->
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="showShield()">Shield</button>
            <button class="btn btn-secondary" onclick="showUnshield()">Unshield</button>
        </div>
        <button class="btn btn-secondary" style="margin-top: 0.75rem;" onclick="showTransfer()">
            Transfer
        </button>
    </div>
    
    <!-- Shield Modal -->
    <div class="modal-overlay hidden" id="modal-shield" role="dialog" aria-modal="true" aria-labelledby="modal-shield-title">
        <div class="modal">
            <h3 class="modal-title" id="modal-shield-title">Shield Funds</h3>
            <p class="card-desc">Deposit tokens into the Railgun pool. Your balance becomes private.</p>
            
            <div class="input-group">
                <label class="input-label" for="shield-amount">Amount</label>
                <input type="number" step="0.0001" min="0" class="input" id="shield-amount" placeholder="0.0">
                <div class="input-error" id="shield-error"></div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Token</label>
                <input type="text" class="input" value="ETH" disabled>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('modal-shield')">Cancel</button>
                <button class="btn btn-primary" id="btn-shield" onclick="executeShield(this)">Shield</button>
            </div>
        </div>
    </div>
    
    <!-- Transfer Modal -->
    <div class="modal-overlay hidden" id="modal-transfer" role="dialog" aria-modal="true" aria-labelledby="modal-transfer-title">
        <div class="modal">
            <h3 class="modal-title" id="modal-transfer-title">Private Transfer</h3>
            <p class="card-desc">Send to another 0zk address. Fully private, on-chain.</p>
            
            <div class="input-group">
                <label class="input-label" for="transfer-to">Recipient (0zk address)</label>
                <input type="text" class="input" id="transfer-to" placeholder="0zk...">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="transfer-amount">Amount</label>
                <input type="number" step="0.0001" min="0" class="input" id="transfer-amount" placeholder="0.0">
                <div class="input-error" id="transfer-error"></div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('modal-transfer')">Cancel</button>
                <button class="btn btn-primary" id="btn-transfer" onclick="executeTransfer(this)">Transfer</button>
            </div>
        </div>
    </div>
    
    <!-- Unshield Modal -->
    <div class="modal-overlay hidden" id="modal-unshield" role="dialog" aria-modal="true" aria-labelledby="modal-unshield-title">
        <div class="modal">
            <h3 class="modal-title" id="modal-unshield-title">Unshield Funds</h3>
            <p class="card-desc">Withdraw to a public Ethereum address.</p>
            
            <div class="input-group">
                <label class="input-label" for="unshield-to">Recipient Address</label>
                <input type="text" class="input" id="unshield-to" placeholder="0x...">
            </div>
            
            <div class="input-group">
                <label class="input-label" for="unshield-amount">Amount</label>
                <input type="number" step="0.0001" min="0" class="input" id="unshield-amount" placeholder="0.0">
                <div class="input-error" id="unshield-error"></div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideModal('modal-unshield')">Cancel</button>
                <button class="btn btn-primary" id="btn-unshield" onclick="executeUnshield(this)">Unshield</button>
            </div>
        </div>
    </div>
    
    <footer>
        <a href="https://github.com/igor53627/voidgun">GitHub</a>
        <a href="./protocol-visualization.html">Docs</a>
        <a href="https://railgun.org">Railgun</a>
    </footer>
    
    <script>
        // State
        const appState = {
            stage: 0,
            wallet: {
                address: null,
                isDemo: false
            },
            railgun: {
                keysInitialized: false,
                balance: 0,
                notes: []
            }
        };
        
        // Legacy aliases for compatibility
        let currentStage = 0;
        let connectedAddress = null;
        let keysInitialized = false;
        let balance = 0;
        let notes = [];
        
        function syncState() {
            currentStage = appState.stage;
            connectedAddress = appState.wallet.address;
            keysInitialized = appState.railgun.keysInitialized;
            balance = appState.railgun.balance;
            notes = appState.railgun.notes;
        }
        
        function showDemoBanner() {
            let banner = document.getElementById('demo-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'demo-banner';
                banner.className = 'demo-banner';
                banner.textContent = '[DEMO MODE] No wallet detected - simulated transactions only';
                document.body.insertBefore(banner, document.body.firstChild);
            }
        }
        
        function hideDemoBanner() {
            const banner = document.getElementById('demo-banner');
            if (banner) banner.remove();
        }
        
        // Wallet connection
        async function connectWallet() {
            const btn = document.querySelector('#stage-connect .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            
            await simulateDelay(800);
            
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    if (accounts && accounts[0]) {
                        appState.wallet.address = accounts[0];
                        appState.wallet.isDemo = false;
                        hideDemoBanner();
                    } else {
                        throw new Error('No account returned');
                    }
                } catch (err) {
                    appState.wallet.address = generateMockAddress();
                    appState.wallet.isDemo = true;
                    showDemoBanner();
                }
            } else {
                appState.wallet.address = generateMockAddress();
                appState.wallet.isDemo = true;
                showDemoBanner();
            }
            
            syncState();
            btn.disabled = false;
            btn.textContent = 'Connect Wallet';
            updateAddressDisplays();
            showStage(1);
        }
        
        async function addNetwork() {
            const btn = document.querySelector('#stage-network .btn-primary');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            await simulateDelay(600);
            
            if (typeof window.ethereum !== 'undefined' && !appState.wallet.isDemo) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: '0x1',
                            chainName: 'Voidgun',
                            rpcUrls: ['https://rpc.voidgun.io'],
                            nativeCurrency: {
                                name: 'Ether',
                                symbol: 'ETH',
                                decimals: 18
                            }
                        }]
                    });
                } catch (err) {
                    console.log('Network add skipped');
                }
            }
            
            btn.disabled = false;
            btn.textContent = 'Add Network';
            showStage(2);
        }
        
        function skipNetwork() {
            showStage(2);
        }
        
        async function deriveKeys(btn) {
            btn.disabled = true;
            btn.textContent = 'Signing...';
            
            await simulateDelay(500);
            
            if (typeof window.ethereum !== 'undefined' && !appState.wallet.isDemo) {
                try {
                    const message = 'Authorize Railgun privacy pool access via Voidgun proxy.\n\nThis signature will be used to derive your Railgun wallet keys deterministically.';
                    await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, appState.wallet.address]
                    });
                } catch (err) {
                    console.log('Signature rejected, using demo mode');
                    appState.wallet.isDemo = true;
                    showDemoBanner();
                }
            }
            
            btn.textContent = 'Deriving Keys...';
            await simulateDelay(1000);
            
            appState.railgun.keysInitialized = true;
            appState.railgun.balance = 0;
            appState.railgun.notes = [];
            syncState();
            
            btn.disabled = false;
            btn.textContent = 'Sign & Derive Keys';
            showStage(3);
        }
        
        function updateProgress(stage) {
            document.querySelectorAll('.step').forEach((step, idx) => {
                step.classList.remove('active', 'completed');
                step.removeAttribute('aria-current');
                if (idx < stage) {
                    step.classList.add('completed');
                }
                if (idx === stage) {
                    step.classList.add('active');
                    step.setAttribute('aria-current', 'step');
                }
            });
        }
        
        function showStage(stage) {
            appState.stage = stage;
            syncState();
            
            document.getElementById('stage-connect').classList.add('hidden');
            document.getElementById('stage-network').classList.add('hidden');
            document.getElementById('stage-keys').classList.add('hidden');
            document.getElementById('stage-ready').classList.add('hidden');
            
            const stageIds = ['stage-connect', 'stage-network', 'stage-keys', 'stage-ready'];
            document.getElementById(stageIds[stage]).classList.remove('hidden');
            
            updateProgress(stage);
            
            if (stage === 3) {
                updateDashboard();
            }
        }
        
        function updateAddressDisplays() {
            const addr = appState.wallet.address || '0x0000000000000000000000000000000000000000';
            
            document.getElementById('connected-address').textContent = addr;
            document.getElementById('connected-address-2').textContent = addr;
            document.getElementById('connected-address-3').textContent = addr;
        }
        
        function updateDashboard() {
            document.getElementById('balance-value').textContent = appState.railgun.balance.toFixed(4);
            
            const noteList = document.getElementById('note-list');
            noteList.innerHTML = '';
            
            if (appState.railgun.notes.length === 0) {
                const emptyItem = document.createElement('div');
                emptyItem.className = 'note-item';
                emptyItem.style.justifyContent = 'center';
                emptyItem.style.color = 'var(--text-dim)';
                emptyItem.textContent = 'No shielded notes yet';
                noteList.appendChild(emptyItem);
            } else {
                appState.railgun.notes.forEach((note) => {
                    const item = document.createElement('div');
                    item.className = 'note-item';
                    
                    const tokenDiv = document.createElement('div');
                    tokenDiv.className = 'note-token';
                    
                    const icon = document.createElement('div');
                    icon.className = 'note-icon';
                    icon.textContent = note.token === 'ETH' ? 'E' : '$';
                    
                    const tokenName = document.createElement('span');
                    tokenName.textContent = note.token;
                    
                    tokenDiv.appendChild(icon);
                    tokenDiv.appendChild(tokenName);
                    
                    const amount = document.createElement('span');
                    amount.className = 'note-amount';
                    amount.textContent = note.value.toFixed(4);
                    
                    item.appendChild(tokenDiv);
                    item.appendChild(amount);
                    noteList.appendChild(item);
                });
            }
            
            // Disable transfer/unshield if no balance
            const hasBalance = appState.railgun.balance > 0;
            document.querySelector('.actions .btn-secondary').disabled = !hasBalance;
            document.querySelector('.actions + .btn-secondary').disabled = !hasBalance;
        }
        
        function showModal(id) {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            const firstInput = modal.querySelector('input:not([disabled])');
            if (firstInput) firstInput.focus();
        }
        
        function showShield() {
            clearError('shield-error');
            showModal('modal-shield');
        }
        
        function showTransfer() {
            clearError('transfer-error');
            showModal('modal-transfer');
        }
        
        function showUnshield() {
            clearError('unshield-error');
            showModal('modal-unshield');
        }
        
        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }
        
        function hideAllModals() {
            document.querySelectorAll('.modal-overlay:not(.hidden)').forEach(overlay => {
                overlay.classList.add('hidden');
            });
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = message;
        }
        
        function clearError(elementId) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = '';
        }
        
        // Fixed note spending algorithm
        function spendFromNotes(amount) {
            let remaining = amount;
            const newNotes = [];
            
            for (const n of appState.railgun.notes) {
                if (remaining <= 0) {
                    newNotes.push({ ...n });
                    continue;
                }
                if (n.value <= remaining) {
                    remaining -= n.value;
                } else {
                    newNotes.push({ ...n, value: n.value - remaining });
                    remaining = 0;
                }
            }
            appState.railgun.notes = newNotes;
            syncState();
        }
        
        async function executeShield(btn) {
            const amountInput = document.getElementById('shield-amount');
            const amount = parseFloat(amountInput.value) || 0;
            
            clearError('shield-error');
            
            if (amount <= 0) {
                showError('shield-error', 'Amount must be greater than 0');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Shielding...';
            
            await simulateDelay(1500);
            
            appState.railgun.balance += amount;
            appState.railgun.notes.push({ token: 'ETH', value: amount });
            syncState();
            
            btn.disabled = false;
            btn.textContent = 'Shield';
            hideModal('modal-shield');
            updateDashboard();
            amountInput.value = '';
        }
        
        async function executeTransfer(btn) {
            const toInput = document.getElementById('transfer-to');
            const amountInput = document.getElementById('transfer-amount');
            const to = toInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            
            clearError('transfer-error');
            
            if (!to) {
                showError('transfer-error', 'Enter a recipient address');
                return;
            }
            if (amount <= 0) {
                showError('transfer-error', 'Amount must be greater than 0');
                return;
            }
            if (amount > appState.railgun.balance) {
                showError('transfer-error', 'Insufficient shielded balance');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Transferring...';
            
            await simulateDelay(2000);
            
            appState.railgun.balance -= amount;
            spendFromNotes(amount);
            
            btn.disabled = false;
            btn.textContent = 'Transfer';
            hideModal('modal-transfer');
            updateDashboard();
            toInput.value = '';
            amountInput.value = '';
        }
        
        async function executeUnshield(btn) {
            const toInput = document.getElementById('unshield-to');
            const amountInput = document.getElementById('unshield-amount');
            const to = toInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;
            
            clearError('unshield-error');
            
            if (!to) {
                showError('unshield-error', 'Enter a recipient address');
                return;
            }
            if (!to.startsWith('0x') || to.length !== 42) {
                showError('unshield-error', 'Invalid Ethereum address');
                return;
            }
            if (amount <= 0) {
                showError('unshield-error', 'Amount must be greater than 0');
                return;
            }
            if (amount > appState.railgun.balance) {
                showError('unshield-error', 'Insufficient shielded balance');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Unshielding...';
            
            await simulateDelay(2000);
            
            appState.railgun.balance -= amount;
            spendFromNotes(amount);
            
            btn.disabled = false;
            btn.textContent = 'Unshield';
            hideModal('modal-unshield');
            updateDashboard();
            toInput.value = '';
            amountInput.value = '';
        }
        
        // Utilities
        function simulateDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function generateMockAddress() {
            const chars = '0123456789abcdef';
            let addr = '0x';
            for (let i = 0; i < 40; i++) {
                addr += chars[Math.floor(Math.random() * 16)];
            }
            return addr;
        }
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.add('hidden');
                }
            });
        });
        
        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAllModals();
            }
        });
        
        // Handle wallet account/chain changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (!accounts || !accounts.length) {
                    appState.wallet.address = null;
                    appState.wallet.isDemo = true;
                    showDemoBanner();
                    showStage(0);
                } else {
                    appState.wallet.address = accounts[0];
                    syncState();
                    updateAddressDisplays();
                }
            });
            
            window.ethereum.on('chainChanged', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
