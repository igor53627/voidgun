{
  "project": {
    "name": "Voidgun",
    "description": "Privacy-via-proxy architecture for Ethereum using Railgun protocol integration",
    "version": "0.2.0",
    "repository": "https://github.com/igor53627/voidgun"
  },
  "architecture": {
    "overview": "Voidgun provides privacy pool access through Railgun's battle-tested Groth16 circuits. Keys are derived deterministically from wallet signatures, enabling privacy without new seed phrases.",
    "crates": {
      "railgun-lane": "Complete Railgun protocol implementation - EdDSA signatures, Groth16 proofs, Merkle sync, note encryption",
      "voidgun-proxy": "Standalone RPC proxy server for privacy-via-proxy - intercepts wallet RPC calls and routes through Railgun (no reth dependency)"
    }
  },
  "voidgun_proxy_modules": {
    "main": "CLI entry point with --upstream, --chain-id, --port, --db flags",
    "server": "Axum HTTP/WebSocket server with JSON-RPC endpoint and /health check",
    "proxy": "Core RPC routing - dispatches to handlers or forwards upstream",
    "methods": "Custom voidgun_* methods and intercepted eth_* methods",
    "context": "UserContextStore for per-wallet RailgunLane instances",
    "db": "SQLite persistence for wallet state across restarts",
    "jsonrpc": "JSON-RPC 2.0 request/response types",
    "error": "ProxyError enum with JSON-RPC error codes"
  },
  "railgun_lane_modules": {
    "artifacts": "Circuit artifact management - downloads WASM/ZKEY/VKEY from IPFS",
    "bip32": "BIP32 key derivation for Baby Jubjub curve",
    "contracts": "Railgun contract ABIs, addresses, and calldata builders",
    "event_loader": "Shield/Transact event parsing and Merkle tree building",
    "keys": "EdDSA keys - SpendingKey, ViewingKey, NullifyingKey, RailgunWallet",
    "lane": "PoolLane trait implementation with sync and transfer methods",
    "notes": "Note structure, commitment, encryption/decryption (ChaCha20-Poly1305, AES-GCM)",
    "poseidon": "Circomlib-compatible Poseidon hash (light-poseidon)",
    "prover": "Groth16 proof generation/verification using ark-circom",
    "rpc": "Ethereum RPC client for event syncing"
  },
  "technologies": {
    "zk": ["Groth16", "ark-circom", "Railgun trusted setup"],
    "crypto": ["Baby Jubjub (EdDSA)", "Poseidon hash", "ChaCha20-Poly1305", "AES-GCM", "X25519 ECDH"],
    "blockchain": ["Ethereum", "Railgun contracts"],
    "rust": ["arkworks (ark-bn254, ark-groth16)", "alloy", "tokio", "wasmer"]
  },
  "key_concepts": {
    "eddsa_circomlib": {
      "description": "EdDSA on Baby Jubjub using circomlib's Poseidon-based variant",
      "signing_equation": "S = r + H(R, A, M) * s (mod subOrder)",
      "verification_equation": "S * Base8 == R8 + 8 * H(R, A, M) * A",
      "key_derivation": "A = Base8 * (s >> 3) where s is pruned blake512 hash",
      "coordinate_transform": "x_ark = sqrt(168700) * x_circ for arkworks <-> circomlib"
    },
    "note_structure": {
      "fields": ["npk (note public key)", "token", "value", "random"],
      "npk_derivation": "npk = Poseidon(masterPublicKey, random)",
      "commitment": "Poseidon(npk, token, value)",
      "nullifier": "Poseidon(nullifyingKey, leafIndex)"
    },
    "circuit_variants": {
      "naming": "InputsxOutputs format",
      "examples": ["01x01 (simple)", "02x02 (with change)", "08x02 (consolidation)"],
      "artifacts": "WASM for witness, ZKEY for proving, VKEY for verification"
    },
    "merkle_tree": {
      "depth": 16,
      "max_depth_constant": "MAX_MERKLE_DEPTH = 16",
      "capacity": "2^16 = 65536 leaves per tree",
      "hash": "Poseidon with BN254 scalar field",
      "sync": "Built from on-chain Shield/Transact events",
      "validation": "Depth and capacity validated at construction/insertion"
    }
  },
  "key_derivation_flow": {
    "step1": "User signs domain message with wallet (ECDSA)",
    "step2": "Extract 128-bit entropy: keccak256(signature)[0:16]",
    "step3": "Generate BIP39 mnemonic (12 words)",
    "step4": "Derive BIP32 master key on Baby Jubjub curve",
    "step5": "Derive spending key: m/44'/1984'/0'/0'",
    "step6": "Derive viewing key: m/420'/1984'/0'/0'"
  },
  "testing": {
    "unit_tests": "cargo test -p railgun-lane && cargo test -p voidgun-proxy",
    "proof_generation": "cargo test -p railgun-lane --test proof_generation -- --ignored",
    "e2e_lane": "cargo test -p railgun-lane --test onchain_verification test_e2e_auto_vnet -- --ignored --nocapture",
    "e2e_proxy": "cargo test -p voidgun-proxy --test e2e_tenderly -- --ignored --nocapture",
    "proxy_tests": "cargo test -p voidgun-proxy",
    "requires": {
      "tenderly": "TENDERLY_ACCESS_KEY, TENDERLY_ACCOUNT, TENDERLY_PROJECT",
      "mainnet_rpc": "MAINNET_RPC_URL or ETH_RPC_URL for read-only tests"
    }
  },
  "recent_changes": {
    "security_audit_fixes": {
      "date": "2024-12-19",
      "description": "Addressed security audit findings in Merkle tree and prover",
      "fixes": [
        "VULN-001/002: NoteMerkleTree::new() validates depth <= 16, returns Result",
        "VULN-001/002: NoteMerkleTree::insert() checks capacity, returns Result",
        "VULN-003: validate_transact_witness() validates Merkle proof shapes before circuit",
        "VULN-004: Witness padding only allows diff of 1, errors on larger mismatches"
      ]
    },
    "refactor_railgun_only": {
      "date": "2024-12-19",
      "description": "Removed original Voidgun pool implementation, kept only Railgun lane",
      "removed": ["voidgun-core", "voidgun-prover", "voidgun-contracts", "circuits/", "contracts/"]
    },
    "eddsa_secret_fix": {
      "date": "2024-12-19",
      "issue": "BabyJubjubScalar reduced secret mod field order, breaking s = 8 * (s >> 3)",
      "fix": "Store secret as raw bytes, use BigUint for arithmetic"
    },
    "voidgun_proxy": {
      "date": "2024-12-24",
      "description": "Added voidgun-proxy RPC server for privacy-via-proxy (issue #46)",
      "features": [
        "JSON-RPC server with custom voidgun_* methods",
        "Transparent interception of eth_getBalance, eth_sendTransaction, personal_sign",
        "SQLite persistence for wallet state",
        "Automatic key derivation from wallet signature"
      ]
    }
  }
}
